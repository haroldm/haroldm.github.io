<!doctype html><html lang=en data-palette=indigo>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Damn Vulnerable DeFi Write-Up - A reverse engineering notebook</title><link rel=apple-touch-icon href=https://haroldm.github.io/images/icons/icon-180x180.png sizes=180x180>
<link rel=icon href=https://haroldm.github.io/images/icons/icon-32x32.png sizes=32x32 type=image/png>
<link rel=icon href=https://haroldm.github.io/images/icons/icon-16x16.png sizes=16x16 type=image/png>
<link rel=icon href=https://haroldm.github.io/images/icons/favicon.ico>
<link rel=manifest href=https://haroldm.github.io/manifest.json>
<meta name=keywords content>
<meta name=description content="Introduction I recently completed the Damn Vulnerable DeFi set of challenges. These challenges makes a good break-in into the EVM smart-contract auditing world. With this write-up I hope to provide some insight about the challenges bugs. I also want to highlight some quirks and oddities about the dev environments and frameworks.
The challenges have been updated and 4 levels have been added in November 2021: this write-up is about the updated version, so you&rsquo;ll have no problem about copy-pasting solutions."><meta name=robots content="index, follow"><meta itemprop=name content="Damn Vulnerable DeFi Write-Up">
<meta itemprop=description content="Introduction I recently completed the Damn Vulnerable DeFi set of challenges. These challenges makes a good break-in into the EVM smart-contract auditing world. With this write-up I hope to provide some insight about the challenges bugs. I also want to highlight some quirks and oddities about the dev environments and frameworks.
The challenges have been updated and 4 levels have been added in November 2021: this write-up is about the updated version, so you&rsquo;ll have no problem about copy-pasting solutions."><meta itemprop=datePublished content="2022-02-23T00:29:23+01:00">
<meta itemprop=dateModified content="2022-02-23T00:29:23+01:00">
<meta itemprop=wordCount content="2580">
<meta itemprop=keywords content="defi,"><meta property="og:title" content="Damn Vulnerable DeFi Write-Up">
<meta property="og:description" content="Introduction I recently completed the Damn Vulnerable DeFi set of challenges. These challenges makes a good break-in into the EVM smart-contract auditing world. With this write-up I hope to provide some insight about the challenges bugs. I also want to highlight some quirks and oddities about the dev environments and frameworks.
The challenges have been updated and 4 levels have been added in November 2021: this write-up is about the updated version, so you&rsquo;ll have no problem about copy-pasting solutions.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://haroldm.github.io/posts/damn-vulnerable-defi-write-up/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-02-23T00:29:23+01:00">
<meta property="article:modified_time" content="2022-02-23T00:29:23+01:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Damn Vulnerable DeFi Write-Up">
<meta name=twitter:description content="Introduction I recently completed the Damn Vulnerable DeFi set of challenges. These challenges makes a good break-in into the EVM smart-contract auditing world. With this write-up I hope to provide some insight about the challenges bugs. I also want to highlight some quirks and oddities about the dev environments and frameworks.
The challenges have been updated and 4 levels have been added in November 2021: this write-up is about the updated version, so you&rsquo;ll have no problem about copy-pasting solutions.">
<meta property="og:image" content="https://haroldm.github.io/false">
<meta name=twitter:image content="https://haroldm.github.io/false"><link rel=stylesheet href=https://haroldm.github.io/css/main.min.7fde4d4168ea6b6fb62bd4345d017ee6d949f0a09d9988a2bc416542e602e89a.css integrity="sha256-f95NQWjqa2+2K9Q0XQF+5tlJ8KCdmYiivEFlQuYC6Jo=" crossorigin=anonymous><link rel=stylesheet href=https://haroldm.github.io/css/custom.css crossorigin=anonymous><link rel=stylesheet href=https://haroldm.github.io/css/viewer.min.3d228794bcedbbfa0412beb8fbc1ec6973202945e42af7004f742a4d7bd620ab.css integrity="sha256-PSKHlLztu/oEEr64+8HsaXMgKUXkKvcAT3QqTXvWIKs=" crossorigin=anonymous></head><body><script>const items=["mode","palette"];items.forEach(function(e){const t=localStorage.getItem("hbs-"+e);t&&document.body.parentElement.setAttribute("data-"+e,t)})</script><header><nav class="navbar top-app-bar top-app-bar-expand-lg fixed-top">
<div class=container>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<i class="fas fa-bars"></i>
</button><a class="navbar-brand flex-grow-1 flex-lg-grow-0 text-center text-lg-start mx-auto me-lg-3" href=https://haroldm.github.io/>A reverse engineering notebook
</a>
<div class="offcanvas offcanvas-bottom surface" tabindex=-1 id=offcanvasSocialShare aria-labelledby=offcanvasSocialShare>
<div class=offcanvas-header>
<h3 class=offcanvas-title>Share</h3><button type=button class="btn btn-sm btn-outline-primary" data-bs-dismiss=offcanvas aria-label=Close>
<i class="fas fa-times"></i>
</button>
</div><div class=offcanvas-body>
<a class="btn btn-sm btn-outline-primary social-share-button" rel="noopener noreferrer" aria-label="Twitter Share Button" target=_blank href="https://twitter.com/intent/tweet?title=Damn%20Vulnerable%20DeFi%20Write-Up&url=https%3a%2f%2fharoldm.github.io%2fposts%2fdamn-vulnerable-defi-write-up%2f">
<i class="fab fa-fw fa-twitter"></i> Twitter
</a>
<a class="btn btn-sm btn-outline-primary social-share-button" rel="noopener noreferrer" aria-label="Facebook Share Button" target=_blank href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fharoldm.github.io%2fposts%2fdamn-vulnerable-defi-write-up%2f">
<i class="fab fa-fw fa-facebook-f"></i> Facebook
</a>
</div></div><form class="navbar-settings mode-switcher-form">
<div class="form-check form-switch">
<input class=form-check-input type=checkbox id=modeSwitcher>
</div></form><div class="collapse navbar-collapse" tabindex=-1 id=navbarSupportedContent aria-labelledby=navbarSupportedContent>
<ul class="navbar-nav ms-auto"></ul></div></div></nav></header><main role=main class=container>
<div class="row content">
<div class=col-lg-8>
<div class=container><nav class="row card component" aria-label=breadcrumb>
<div class=card-body>
<ol class=breadcrumb><li class=breadcrumb-item><a href=https://haroldm.github.io/>Home</a></li><li class=breadcrumb-item><a href=https://haroldm.github.io/posts/>Posts</a></li><li class="breadcrumb-item active">Damn Vulnerable DeFi Write-Up</li></ol></div></nav><div class=post-panel-wrapper>
<div class="d-flex flex-column component rounded post-panel">
<a class="action action-panel-toggler" role=button title="Panel toggler">
<i class="fas fa-fw fa-chevron-circle-down"></i>
</a>
<a id=sidebarToggler class="action d-none d-lg-block" role=button title="Sidebar toggler">
<i class="fas fa-fw fa-expand-alt" data-fa-transform=rotate-45></i>
</a>
<a class=action href=#post-comments role=button aria-label=Comments title=Comments>
<i class="fas fa-fw fa-comments"></i>
</a>
<a class=action href=#postTOC aria-controls="Table of contents" role=button title="Table of contents">
<i class="fas fa-fw fa-list-alt"></i>
</a>
</div></div><article class="row card component mb-4 post">
<div class=card-header>
<h1 class="card-title post-title">Damn Vulnerable DeFi Write-Up
</h1></div><div class=card-body><div class=post-meta>
<span class=post-date title="created on 2022-02-22 23:29:23 +0000 UTC.">
Feb 23, 2022
</span><span class=post-reading-time>
13 min read
</span><span class=post-taxonomies><a href=https://haroldm.github.io/tags/defi/ class="badge post-taxonomy">defi</a></span>
</div><div class="post-content mb-3"><h2 id=introduction>Introduction<a class="anchor ms-1" href=#introduction><i class="fas fa-link"></i></a></h2><p>I recently completed the <a href=https://www.damnvulnerabledefi.xyz/ target=_blank rel="noopener noreferrer">Damn Vulnerable DeFi</a> set of challenges. These challenges makes a good break-in into the EVM smart-contract auditing world. With this write-up I hope to provide some insight about the challenges bugs. I also want to highlight some quirks and oddities about the dev environments and frameworks.</p><p>The challenges have been updated and 4 levels have been added in November 2021: this write-up is about the updated version, so you&rsquo;ll have no problem about copy-pasting solutions. However, if you haven&rsquo;t completed the challenges I advise you to go try them yourself and come after. All you should need is the <a href=https://docs.soliditylang.org/en/v0.8.12/ target=_blank rel="noopener noreferrer">Solidity documentation</a> and <a href=https://docs.ethers.io/v5/ target=_blank rel="noopener noreferrer">Ethers documentation</a>. If you struggle with your exploit implementation once you found a bug and an exploitation route, looking at a solution is ok but you get most value of these challenges by solving them on your own and looking at anyone else solution afterwards. I want to highlight challenges number 4, 6, 11 and 12 as the most interesting ones.</p><p>The development environment is based around Hardhat: it seems to be the most recent and complete library in the field. One of the best feature is logging which is described <a href=https://hardhat.org/hardhat-network/reference/#console-log target=_blank rel="noopener noreferrer">here</a>.</p><h2 id=challenge-1-unstoppable>Challenge 1: Unstoppable<a class="anchor ms-1" href=#challenge-1-unstoppable><i class="fas fa-link"></i></a></h2><p>In this challenge you have to trigger a DoS vulnerability. Reading the code should makes you wonder if the check highlighted below isn&rsquo;t too strict and what would happen if you graciously send the pool 1 DVT token&mldr;</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=kd>function</span> <span class=nf>flashLoan</span><span class=p>(</span><span class=kt>uint256</span> <span class=n>borrowAmount</span><span class=p>)</span> <span class=k>external</span> <span class=n>nonReentrant</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=n>borrowAmount</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;Must borrow at least one token&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>uint256</span> <span class=n>balanceBefore</span> <span class=o>=</span> <span class=n>damnValuableToken</span><span class=p>.</span><span class=n>balanceOf</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=n>balanceBefore</span> <span class=o>&gt;=</span> <span class=n>borrowAmount</span><span class=p>,</span> <span class=s>&#34;Not enough tokens in pool&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// Ensured by the protocol via the `depositTokens` function
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=nb>assert</span><span class=p>(</span><span class=n>poolBalance</span> <span class=o>==</span> <span class=n>balanceBefore</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>damnValuableToken</span><span class=p>.</span><span class=nb>transfer</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>,</span> <span class=n>borrowAmount</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>IReceiver</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>).</span><span class=n>receiveTokens</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=n>damnValuableToken</span><span class=p>),</span> <span class=n>borrowAmount</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kt>uint256</span> <span class=n>balanceAfter</span> <span class=o>=</span> <span class=n>damnValuableToken</span><span class=p>.</span><span class=n>balanceOf</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=n>balanceAfter</span> <span class=o>&gt;=</span> <span class=n>balanceBefore</span><span class=p>,</span> <span class=s>&#34;Flash loan hasn&#39;t been paid back&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Here is how to do it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>token</span><span class=p>.</span><span class=nx>connect</span><span class=p>(</span><span class=nx>attacker</span><span class=p>).</span><span class=nx>transfer</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>pool</span><span class=p>.</span><span class=nx>address</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span></code></pre></div><ul>
<li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/tree/solutions/contracts/unstoppable target=_blank rel="noopener noreferrer">See challenge contracts</a></li><li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/blob/solutions/test/unstoppable/unstoppable.challenge.js target=_blank rel="noopener noreferrer">See deploy and exploit JS code</a></li></ul><h2 id=challenge-2-naive-receiver>Challenge 2: Naive receiver<a class="anchor ms-1" href=#challenge-2-naive-receiver><i class="fas fa-link"></i></a></h2><p>In this challenge a <a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/blob/solutions/contracts/naive-receiver/NaiveReceiverLenderPool.sol target=_blank rel="noopener noreferrer">pool</a> interacts with a <a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/blob/solutions/contracts/naive-receiver/FlashLoanReceiver.sol target=_blank rel="noopener noreferrer">receiver contract</a>. The pool contract can only interact with contracts implementing the <code>receiveEther(uint256)</code> function but anyone can make an eligible contract borrow money: that&rsquo;s what we do in the <code>NaiveReceiverAttacker</code> contract below.</p><p>To mitigate this issue either the the pool should include a mechanism to not allow anyone to make an eligible contract borrow money or the receiving contract should check where the borrow originates from (easily done by using <code>tx.origin</code>). Another solution could be to allow only the receiver contract to call the <code>flashLoan</code> function and ditch the <code>borrower</code> parameter. Solutions are not missing, it&rsquo;s just that <code>NaiveReceiverLenderPool</code> has a truly flawed design.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>NaiveReceiverAttacker</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>attack</span><span class=p>(</span><span class=kt>address</span> <span class=n>borrower</span><span class=p>,</span> <span class=kt>address</span> <span class=k>payable</span> <span class=n>lenderpool</span><span class=p>)</span> <span class=k>external</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NaiveReceiverLenderPool</span> <span class=n>pool</span> <span class=o>=</span> <span class=n>NaiveReceiverLenderPool</span><span class=p>(</span><span class=n>lenderpool</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Receiver has 10 ETH: do 10 0 eth loans to drain his account by
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// forcing him to pay fees
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span><span class=p>(</span><span class=kt>uint</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=mi>10</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>pool</span><span class=p>.</span><span class=n>flashLoan</span><span class=p>(</span><span class=n>borrower</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Deploying a contract is only 2 lines of Javascript code; calling our exploit function is straight forwards:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>NaiveReceiverAttacker</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>ethers</span><span class=p>.</span><span class=nx>getContractFactory</span><span class=p>(</span><span class=s1>&#39;NaiveReceiverAttacker&#39;</span><span class=p>,</span> <span class=nx>attacker</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>attack_contract</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>NaiveReceiverAttacker</span><span class=p>.</span><span class=nx>deploy</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=kr>await</span> <span class=nx>attack_contract</span><span class=p>.</span><span class=nx>attack</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>receiver</span><span class=p>.</span><span class=nx>address</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>pool</span><span class=p>.</span><span class=nx>address</span><span class=p>);</span>
</span></span></code></pre></div><blockquote>
<p>We deployed the contract as <code>attacker</code> so we don&rsquo;t need to explicitly connect to it: the default Signer will be the deployer.</p></blockquote><ul>
<li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/tree/solutions/contracts/naive-receiver target=_blank rel="noopener noreferrer">See challenge contracts</a></li><li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/blob/solutions/test/unstoppable/unstoppable.challenge.js target=_blank rel="noopener noreferrer">See deploy and exploit JS code</a></li><li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/blob/solutions/contracts/attacker-contracts/NaiveReceiverAttacker.sol target=_blank rel="noopener noreferrer">See exploit contract</a></li></ul><h2 id=challenge-3-truster>Challenge 3: Truster<a class="anchor ms-1" href=#challenge-3-truster><i class="fas fa-link"></i></a></h2><p>In this challenge we face a loan contract whose <code>flashLoan(uint256 borrowAmount, address borrower, address target, bytes calldata data)</code> prototype looks shady: we can provide <code>target</code> and <code>data</code> which will be called by the contract during the loan. As we can choose the target we choose to call the <code>DVT</code> contract to approve ourself to transfer the tokens: here is the <a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/blob/solutions/contracts/attacker-contracts/TrusterAttacker.sol target=_blank rel="noopener noreferrer">code</a> of the attacker contract.</p><p>Here the design flaw is to allow any target to be called: only the contract asking fo the loan should be allowed to be called back. Reentrancy should also be taken into account but looking at challenge titles it seems to be the subject of the next one.</p><ul>
<li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/blob/solutions/contracts/truster/TrusterLenderPool.sol target=_blank rel="noopener noreferrer">See challenge contract</a></li><li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/blob/solutions/test/truster/truster.challenge.js target=_blank rel="noopener noreferrer">See deploy and exploit JS code</a></li><li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/blob/solutions/contracts/attacker-contracts/TrusterAttacker.sol target=_blank rel="noopener noreferrer">See exploit contract</a></li></ul><h2 id=challenge-4-side-entrance>Challenge 4: Side entrance<a class="anchor ms-1" href=#challenge-4-side-entrance><i class="fas fa-link"></i></a></h2><p>This flash loan pool seems to have better design than in the last challenge: here the <code>execute</code> function of the loaner is executed and handed the flash loan.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln>1</span><span class=cl><span class=kd>function</span> <span class=nf>flashLoan</span><span class=p>(</span><span class=kt>uint256</span> <span class=n>amount</span><span class=p>)</span> <span class=k>external</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>    <span class=kt>uint256</span> <span class=n>balanceBefore</span> <span class=o>=</span> <span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>).</span><span class=nb>balance</span><span class=p>;</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=n>balanceBefore</span> <span class=o>&gt;=</span> <span class=n>amount</span><span class=p>,</span> <span class=s>&#34;Not enough ETH in balance&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>    
</span></span><span class=line><span class=ln>5</span><span class=cl>    <span class=n>IFlashLoanEtherReceiver</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>).</span><span class=n>execute</span><span class=p>{</span><span class=nb>value</span><span class=o>:</span> <span class=n>amount</span><span class=p>}();</span>
</span></span><span class=line><span class=ln>6</span><span class=cl>
</span></span><span class=line><span class=ln>7</span><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>).</span><span class=nb>balance</span> <span class=o>&gt;=</span> <span class=n>balanceBefore</span><span class=p>,</span> <span class=s>&#34;Flash loan hasn&#39;t been paid back&#34;</span><span class=p>);</span>        
</span></span><span class=line><span class=ln>8</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The loaner is handed some money on line 5, then if the money isn&rsquo;t sent back the <code>require</code> statement line 7 will fail and the transaction will be reverted. Nothing bad could happen right ? Someone thinking that could not be more wrong: sneaky as we are we will send back the money not with the classic <code>transfer</code> function but by calling the <code>deposit</code> function and increasing our balance so it equals the entire pool money. Then, in the same transaction we can <code>withdraw</code> our ETH and empty the pool: the challenge is completed.</p><p>What is the flaw in the contract ? We reentered the contract after getting our flash loan and managed to modify its state to our advantage: this is a classic <em>reentrancy bug</em>. The first three challenges were not very realistic situations but this one shows a vulnerability pattern you can encounter in the real world: the infamous <a href=https://hackingdistributed.com/2016/06/18/analysis-of-the-dao-exploit/ target=_blank rel="noopener noreferrer">DAO hack</a> is based on a reentrancy exploit.</p><ul>
<li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/blob/solutions/contracts/side-entrance/SideEntranceLenderPool.sol target=_blank rel="noopener noreferrer">See challenge contract</a></li><li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/blob/solutions/test/side-entrance/side-entrance.challenge.js target=_blank rel="noopener noreferrer">See deploy and exploit JS code</a></li><li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/blob/solutions/contracts/attacker-contracts/SideEntranceAttacker.sol target=_blank rel="noopener noreferrer">See exploit contract</a></li></ul><h2 id=challenge-5-the-rewarder>Challenge 5: The rewarder<a class="anchor ms-1" href=#challenge-5-the-rewarder><i class="fas fa-link"></i></a></h2><p>The rewarder pool from this challenge give rewards base on who is holding token when the <code>deposit</code> function is called. We can then leverage a flash loan to deposit money only during one round and as long as we didn&rsquo;t already claimed reward for the current round, we will receive rewards.</p><ul>
<li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/tree/solutions/contracts/the-rewarder target=_blank rel="noopener noreferrer">See challenge contracts</a></li><li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/blob/solutions/test/the-rewarder/the-rewarder.challenge.js target=_blank rel="noopener noreferrer">See deploy and exploit JS code</a></li><li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/blob/solutions/contracts/attacker-contracts/TheRewarderAttacker.sol target=_blank rel="noopener noreferrer">See exploit contract</a></li></ul><h2 id=challenge-6-selfie>Challenge 6: Selfie<a class="anchor ms-1" href=#challenge-6-selfie><i class="fas fa-link"></i></a></h2><p>The pool have a function which seems very interesting: <code>drainAllFunds(address receiver)</code> but calling it is restricted by the <code>onlyGovernance</code> modifier.</p><p>The OpenZeppelin documentation on <a href=https://docs.openzeppelin.com/contracts/4.x/api/token/erc20#ERC20Snapshot-_snapshot-- target=_blank rel="noopener noreferrer">ERC20Snapshot</a> mentions than allowing anyone to call <code>_snapshot</code> can be used by attackers. It does not explicit the bug we are facing: in this challenge we can create a snapshot while holding tokens from a flash loan: triggering a snapshot and queuing an action calling to <code>drainAllFunds</code> is then all it takes to beat this challenge. Then we have to wait for at least 2 days to execute the action.</p><p>Developing this exploit took me quite some time because we need to read blockchain events to retrieve the action id in an event emitted by <code>queueAction</code> in the SimpleGovernance contract.
There is one subtlety here: because we are calling our own contract, ethers.js will not be aware of the event ABI of the SimpleGovernance contract. We could get around this by for instance emitting our own event in the attacking contract or by filtering through all blocks. I find the cleanest way of doing it is to add the events we want to parse in the attacking contract ABI: this is the solution chosen in my code but there also is a commented alternative method.</p><ul>
<li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/tree/solutions/contracts/selfie target=_blank rel="noopener noreferrer">See challenge contracts</a></li><li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/blob/solutions/test/selfie/selfie.challenge.js target=_blank rel="noopener noreferrer">See deploy and exploit JS code</a></li><li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/blob/solutions/contracts/attacker-contracts/SelfieAttacker.sol target=_blank rel="noopener noreferrer">See exploit contract</a></li></ul><h2 id=challenge-7-compromised>Challenge 7: Compromised<a class="anchor ms-1" href=#challenge-7-compromised><i class="fas fa-link"></i></a></h2><p>Analyzing the HTTP capture with a tool like <a href=https://gchq.github.io/CyberChef/ target=_blank rel="noopener noreferrer">CyberChef</a> expose two Ethereum private keys allowing us to send transaction as two of the three oracles. We can thus set the price we want as the median price is used. Getting the money is just a matter of using the Exchange contract.</p><ul>
<li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/tree/solutions/contracts/compromised target=_blank rel="noopener noreferrer">See challenge contracts</a></li><li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/blob/solutions/test/compromised/compromised.challenge.js target=_blank rel="noopener noreferrer">See deploy and exploit JS code</a></li></ul><h2 id=challenge-8-puppet>Challenge 8: Puppet<a class="anchor ms-1" href=#challenge-8-puppet><i class="fas fa-link"></i></a></h2><p>We are facing a lending pool and an Uniswap v1 pair. Change rate is calculated with a very simple formula:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=kd>function</span> <span class=nf>_computeOraclePrice</span><span class=p>()</span> <span class=k>private</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>uint256</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// calculates the price of the token in wei according to Uniswap pair
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>uniswapPair</span><span class=p>.</span><span class=nb>balance</span> <span class=o>*</span> <span class=p>(</span><span class=mi>10</span> <span class=o>**</span> <span class=mi>18</span><span class=p>)</span> <span class=o>/</span> <span class=n>token</span><span class=p>.</span><span class=n>balanceOf</span><span class=p>(</span><span class=n>uniswapPair</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The lending pool is using this rate to provide loans where we have to provide twice the collateral.
If the Uniswap pair ETH balance is close to zero then the rate is going to be very low. Luckily we have more ETH and DVT than the Uniswap pair so we can manipulate the price: we swap DVT for ETH so the pool has almost no ETH left: we can now borrow DVT to the pool at a very interesting rate.</p><ul>
<li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/blob/solutions/contracts/puppet/PuppetPool.sol target=_blank rel="noopener noreferrer">See challenge contract</a></li><li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/blob/solutions/test/puppet/puppet.challenge.js target=_blank rel="noopener noreferrer">See deploy and exploit JS code</a></li></ul><h2 id=challenge-9-puppet-v2>Challenge 9: Puppet v2<a class="anchor ms-1" href=#challenge-9-puppet-v2><i class="fas fa-link"></i></a></h2><p>This challenge is called Puppet v2 because it upgrade the Uniswap pair to v2 but apparently the pool developer did not read the <a href=https://docs.uniswap.org/protocol/V2/concepts/core-concepts/oracles target=_blank rel="noopener noreferrer">oracle</a> part of the documentation: we process the same as for previous challenge except for the increased boilerplate code.</p><ul>
<li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/blob/solutions/contracts/puppet-v2/PuppetV2Pool.sol target=_blank rel="noopener noreferrer">See challenge contract</a></li><li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/tree/solutions/test/puppet-v2 target=_blank rel="noopener noreferrer">See deploy and exploit JS code</a></li></ul><h2 id=challenge-10-free-rider>Challenge 10: Free rider<a class="anchor ms-1" href=#challenge-10-free-rider><i class="fas fa-link"></i></a></h2><p>The vulnerability in this challenge is trivial to spot: the developer thought than on line 13 the contract would send tokens to the seller but it sends money to the new owner: the NFT has been transferred on line 11 !</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln> 1</span><span class=cl><span class=kd>function</span> <span class=nf>_buyOne</span><span class=p>(</span><span class=kt>uint256</span> <span class=n>tokenId</span><span class=p>)</span> <span class=k>private</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>    <span class=kt>uint256</span> <span class=n>priceToPay</span> <span class=o>=</span> <span class=n>offers</span><span class=p>[</span><span class=n>tokenId</span><span class=p>];</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=n>priceToPay</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;Token is not being offered&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>
</span></span><span class=line><span class=ln> 5</span><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>value</span> <span class=o>&gt;=</span> <span class=n>priceToPay</span><span class=p>,</span> <span class=s>&#34;Amount paid is not enough&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>
</span></span><span class=line><span class=ln> 7</span><span class=cl>    <span class=n>amountOfOffers</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>
</span></span><span class=line><span class=ln> 9</span><span class=cl>    <span class=c1>// transfer from seller to buyer
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=c1></span>    <span class=n>token</span><span class=p>.</span><span class=n>safeTransferFrom</span><span class=p>(</span><span class=n>token</span><span class=p>.</span><span class=n>ownerOf</span><span class=p>(</span><span class=n>tokenId</span><span class=p>),</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>,</span> <span class=n>tokenId</span><span class=p>);</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>
</span></span><span class=line><span class=ln>12</span><span class=cl>    <span class=c1>// pay seller
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=c1></span>    <span class=k>payable</span><span class=p>(</span><span class=n>token</span><span class=p>.</span><span class=n>ownerOf</span><span class=p>(</span><span class=n>tokenId</span><span class=p>)).</span><span class=n>sendValue</span><span class=p>(</span><span class=n>priceToPay</span><span class=p>);</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>
</span></span><span class=line><span class=ln>15</span><span class=cl>    <span class=n>emit</span> <span class=n>NFTBought</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>,</span> <span class=n>tokenId</span><span class=p>,</span> <span class=n>priceToPay</span><span class=p>);</span>
</span></span><span class=line><span class=ln>16</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>We can use the deployed uniswap exchange to get a flash loan (here called flash swap) to get the required liquidity: the difficulty of this challenge resides in implementation.</p><ul>
<li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/tree/solutions/contracts/free-rider target=_blank rel="noopener noreferrer">See challenge contracts</a></li><li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/blob/solutions/test/free-rider/free-rider.challenge.js target=_blank rel="noopener noreferrer">See deploy and exploit JS code</a></li><li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/blob/solutions/contracts/attacker-contracts/FreeRiderAttacker.sol target=_blank rel="noopener noreferrer">See exploit contract</a></li></ul><h2 id=challenge-11-backdoor>Challenge 11: Backdoor<a class="anchor ms-1" href=#challenge-11-backdoor><i class="fas fa-link"></i></a></h2><p>Interacting with Gnosis Safe Wallets is perhaps less documented than the Uniswap protocol for instance, and was definitely more confusing to me. So I started by implementing the interactions the developer expected to happen:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>let</span> <span class=nx>userAddresses</span> <span class=o>=</span> <span class=nx>users</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>userSigners</span> <span class=o>=</span> <span class=p>[</span><span class=nx>alice</span><span class=p>,</span> <span class=nx>bob</span><span class=p>,</span> <span class=nx>charlie</span><span class=p>,</span> <span class=nx>david</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>userAddresses</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>initCode</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>masterCopy</span><span class=p>.</span><span class=kr>interface</span><span class=p>.</span><span class=nx>encodeFunctionData</span><span class=p>(</span><span class=s2>&#34;setup&#34;</span><span class=p>,</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=nx>userAddresses</span><span class=p>[</span><span class=nx>i</span><span class=p>]],</span>                 <span class=c1>// _owners
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=mi>1</span><span class=p>,</span>                                  <span class=c1>// _threshold
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>ethers</span><span class=p>.</span><span class=nx>constants</span><span class=p>.</span><span class=nx>AddressZero</span><span class=p>,</span>       <span class=c1>// to (optional delegateCall)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>[],</span>                                 <span class=c1>// data (optional delegateCall)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>ethers</span><span class=p>.</span><span class=nx>constants</span><span class=p>.</span><span class=nx>AddressZero</span><span class=p>,</span>       <span class=c1>// fallbackHandler
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>this</span><span class=p>.</span><span class=nx>token</span><span class=p>.</span><span class=nx>address</span><span class=p>,</span>                 <span class=c1>// paymentToken
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=mi>0</span><span class=p>,</span>                                  <span class=c1>// payment
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>ethers</span><span class=p>.</span><span class=nx>constants</span><span class=p>.</span><span class=nx>AddressZero</span>        <span class=c1>// paymentReceiver
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>walletFactory</span><span class=p>.</span><span class=nx>connect</span><span class=p>(</span><span class=nx>userSigners</span><span class=p>[</span><span class=nx>i</span><span class=p>]).</span><span class=nx>createProxyWithCallback</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>masterCopy</span><span class=p>.</span><span class=nx>address</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>initCode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>walletRegistry</span><span class=p>.</span><span class=nx>address</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>wallet</span> <span class=o>=</span> <span class=kr>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>walletRegistry</span><span class=p>.</span><span class=nx>wallets</span><span class=p>(</span><span class=nx>alice</span><span class=p>.</span><span class=nx>address</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>balance</span> <span class=o>=</span> <span class=kr>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>token</span><span class=p>.</span><span class=nx>balanceOf</span><span class=p>(</span><span class=nx>wallet</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Alice balance: %s DVT&#34;</span><span class=p>,</span> <span class=nx>ethers</span><span class=p>.</span><span class=nx>utils</span><span class=p>.</span><span class=nx>formatEther</span><span class=p>(</span><span class=nx>balance</span><span class=p>));</span>
</span></span></code></pre></div><p>The following <code>proxyCreated</code> function is called upon creation on a wallet.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln> 1</span><span class=cl><span class=kd>function</span> <span class=nf>proxyCreated</span><span class=p>(</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>    <span class=n>GnosisSafeProxy</span> <span class=n>proxy</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>    <span class=kt>address</span> <span class=n>singleton</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>    <span class=kt>bytes</span> <span class=n>calldata</span> <span class=n>initializer</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>    <span class=kt>uint256</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=p>)</span> <span class=k>external</span> <span class=k>override</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>    <span class=c1>// Make sure we have enough DVT to pay
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=c1></span>    <span class=nb>require</span><span class=p>(</span><span class=n>token</span><span class=p>.</span><span class=n>balanceOf</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>))</span> <span class=o>&gt;=</span> <span class=n>TOKEN_PAYMENT</span><span class=p>,</span> <span class=s>&#34;Not enough funds to pay&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=kt>address</span> <span class=k>payable</span> <span class=n>walletAddress</span> <span class=o>=</span> <span class=k>payable</span><span class=p>(</span><span class=n>proxy</span><span class=p>);</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>
</span></span><span class=line><span class=ln>12</span><span class=cl>    <span class=c1>// Ensure correct factory and master copy
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=c1></span>    <span class=nb>require</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span> <span class=o>==</span> <span class=n>walletFactory</span><span class=p>,</span> <span class=s>&#34;Caller must be factory&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=n>singleton</span> <span class=o>==</span> <span class=n>masterCopy</span><span class=p>,</span> <span class=s>&#34;Fake mastercopy used&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>    
</span></span><span class=line><span class=ln>16</span><span class=cl>    <span class=c1>// Ensure initial calldata was a call to `GnosisSafe::setup`
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=c1></span>    <span class=nb>require</span><span class=p>(</span><span class=kt>bytes4</span><span class=p>(</span><span class=n>initializer</span><span class=p>[</span><span class=o>:</span><span class=mi>4</span><span class=p>])</span> <span class=o>==</span> <span class=n>GnosisSafe</span><span class=p>.</span><span class=n>setup</span><span class=p>.</span><span class=nb>selector</span><span class=p>,</span> <span class=s>&#34;Wrong initialization&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>
</span></span><span class=line><span class=ln>19</span><span class=cl>    <span class=c1>// Ensure wallet initialization is the expected
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=c1></span>    <span class=nb>require</span><span class=p>(</span><span class=n>GnosisSafe</span><span class=p>(</span><span class=n>walletAddress</span><span class=p>).</span><span class=n>getThreshold</span><span class=p>()</span> <span class=o>==</span> <span class=n>MAX_THRESHOLD</span><span class=p>,</span> <span class=s>&#34;Invalid threshold&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=n>GnosisSafe</span><span class=p>(</span><span class=n>walletAddress</span><span class=p>).</span><span class=n>getOwners</span><span class=p>().</span><span class=n>length</span> <span class=o>==</span> <span class=n>MAX_OWNERS</span><span class=p>,</span> <span class=s>&#34;Invalid number of owners&#34;</span><span class=p>);</span>       
</span></span><span class=line><span class=ln>22</span><span class=cl>
</span></span><span class=line><span class=ln>23</span><span class=cl>    <span class=c1>// Ensure the owner is a registered beneficiary
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=c1></span>    <span class=kt>address</span> <span class=n>walletOwner</span> <span class=o>=</span> <span class=n>GnosisSafe</span><span class=p>(</span><span class=n>walletAddress</span><span class=p>).</span><span class=n>getOwners</span><span class=p>()[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=ln>25</span><span class=cl>
</span></span><span class=line><span class=ln>26</span><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=n>beneficiaries</span><span class=p>[</span><span class=n>walletOwner</span><span class=p>],</span> <span class=s>&#34;Owner is not registered as beneficiary&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>27</span><span class=cl>
</span></span><span class=line><span class=ln>28</span><span class=cl>    <span class=c1>// Remove owner as beneficiary
</span></span></span><span class=line><span class=ln>29</span><span class=cl><span class=c1></span>    <span class=n>_removeBeneficiary</span><span class=p>(</span><span class=n>walletOwner</span><span class=p>);</span>
</span></span><span class=line><span class=ln>30</span><span class=cl>
</span></span><span class=line><span class=ln>31</span><span class=cl>    <span class=c1>// Register the wallet under the owner&#39;s address
</span></span></span><span class=line><span class=ln>32</span><span class=cl><span class=c1></span>    <span class=n>wallets</span><span class=p>[</span><span class=n>walletOwner</span><span class=p>]</span> <span class=o>=</span> <span class=n>walletAddress</span><span class=p>;</span>
</span></span><span class=line><span class=ln>33</span><span class=cl>
</span></span><span class=line><span class=ln>34</span><span class=cl>    <span class=c1>// Pay tokens to the newly created wallet
</span></span></span><span class=line><span class=ln>35</span><span class=cl><span class=c1></span>    <span class=n>token</span><span class=p>.</span><span class=nb>transfer</span><span class=p>(</span><span class=n>walletAddress</span><span class=p>,</span> <span class=n>TOKEN_PAYMENT</span><span class=p>);</span>        
</span></span><span class=line><span class=ln>36</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>We understand than if Alice (or any <code>walletOwner</code>) creates a wallet in their name they will be rewarded 10 DVT. Understanding how Gnosis Safe wallets works the first idea is to add several owners to the wallet to allow us to have access to the reward. Unfortunately the wallet registry is configured as such as the checks on line 20 and 21 are preventing us to do so. Let&rsquo;s look again at which parameters are available to us in the <code>GnosisSafe::setup</code> function: <code>to</code> and <code>data</code> allow us to <a href=https://docs.soliditylang.org/en/v0.8.12/introduction-to-smart-contracts.html#delegatecall-callcode-and-libraries target=_blank rel="noopener noreferrer">delegatecall</a> into anything we want ! If we delegatecall into code approving us to transfer tokens we can call <code>transferFrom</code> as the attacker.</p><ul>
<li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/blob/solutions/contracts/backdoor/WalletRegistry.sol target=_blank rel="noopener noreferrer">See challenge contract</a></li><li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/blob/solutions/test/backdoor/backdoor.challenge.js target=_blank rel="noopener noreferrer">See deploy and exploit JS code</a></li><li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/blob/solutions/contracts/attacker-contracts/BackdoorAttacker.sol target=_blank rel="noopener noreferrer">See exploit contract</a></li></ul><h2 id=challenge-12-climber>Challenge 12: Climber<a class="anchor ms-1" href=#challenge-12-climber><i class="fas fa-link"></i></a></h2><p>In the set of contracts the challenge gives us we have a pool following the UUPS pattern. This pattern is described in the linked <a href=https://eips.ethereum.org/EIPS/eip-1822 target=_blank rel="noopener noreferrer">EIP-1822</a>. We also see than the vault contract is using the OpenZeppelin implementation <a href=https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/proxy/utils/UUPSUpgradeable.sol target=_blank rel="noopener noreferrer">UUPSUpgradeable</a>. In the UUPSUpgradeable code we see that the contract is also conforming to <a href=https://eips.ethereum.org/EIPS/eip-1967 target=_blank rel="noopener noreferrer">EIP-1967</a>.</p><blockquote>
<p>In fact, the first EIP describes the mechanism while storage slots are defined in the second one.</p></blockquote><p>In the <a href=https://docs.openzeppelin.com/contracts/4.x/api/proxy target=_blank rel="noopener noreferrer">documentation</a> we notice an interesting warning: « Using upgradeable proxies correctly and securely is a difficult task that requires deep knowledge of the proxy pattern, Solidity, and the EVM ». This definitely looks like where the vulnerability will be !</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=ln> 1</span><span class=cl><span class=cm>/** Anyone can execute what has been scheduled via `schedule` */</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=kd>function</span> <span class=nf>execute</span><span class=p>(</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>    <span class=kt>address</span><span class=p>[]</span> <span class=n>calldata</span> <span class=n>targets</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>    <span class=kt>uint256</span><span class=p>[]</span> <span class=n>calldata</span> <span class=n>values</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>    <span class=kt>bytes</span><span class=p>[]</span> <span class=n>calldata</span> <span class=n>dataElements</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>    <span class=kt>bytes32</span> <span class=n>salt</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl><span class=p>)</span> <span class=k>external</span> <span class=k>payable</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=n>targets</span><span class=p>.</span><span class=n>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;Must provide at least one target&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=n>targets</span><span class=p>.</span><span class=n>length</span> <span class=o>==</span> <span class=n>values</span><span class=p>.</span><span class=n>length</span><span class=p>);</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=n>targets</span><span class=p>.</span><span class=n>length</span> <span class=o>==</span> <span class=n>dataElements</span><span class=p>.</span><span class=n>length</span><span class=p>);</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>
</span></span><span class=line><span class=ln>12</span><span class=cl>    <span class=kt>bytes32</span> <span class=n>id</span> <span class=o>=</span> <span class=n>getOperationId</span><span class=p>(</span><span class=n>targets</span><span class=p>,</span> <span class=n>values</span><span class=p>,</span> <span class=n>dataElements</span><span class=p>,</span> <span class=n>salt</span><span class=p>);</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>
</span></span><span class="line hl"><span class=ln>14</span><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>uint8</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>targets</span><span class=p>.</span><span class=n>length</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=ln>15</span><span class=cl>        <span class=n>targets</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>functionCallWithValue</span><span class=p>(</span><span class=n>dataElements</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>values</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class="line hl"><span class=ln>16</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>    
</span></span><span class="line hl"><span class=ln>18</span><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=n>getOperationState</span><span class=p>(</span><span class=n>id</span><span class=p>)</span> <span class=o>==</span> <span class=n>OperationState</span><span class=p>.</span><span class=n>ReadyForExecution</span><span class=p>);</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>    <span class=n>operations</span><span class=p>[</span><span class=n>id</span><span class=p>].</span><span class=n>executed</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=ln>20</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The only interesting entry point accessible without any specific role is <code>execute</code> function in <code>ClimberTimelock</code>. We notice the function is checking if the executed operations were scheduled line 18 after executing them. The transaction will be reversed if the check fails but maybe we can somehow get the check to pass while we control execution flow in the for loop lines 14-16. To reduce this attack surface all smart contract developers should always use the <a href=https://fravoll.github.io/solidity-patterns/checks_effects_interactions.html target=_blank rel="noopener noreferrer">Checks-Effects-Interactions</a> pattern.</p><p>Let&rsquo;s now look at the different permissions and roles in these two contracts. The vault is owned by the timelock contract and can only be upgraded (following the UUPS EIP) by the latter. Two roles are defined (using OpenZeppelin <a href=https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/access/AccessControl.sol target=_blank rel="noopener noreferrer">AccessControl</a> library): <code>ADMIN_ROLE</code> and <code>PROPOSER_ROLE</code>. <code>ADMIN_ROLE</code> is unused: the challenge is probably built from a real world example and some functions have been stripped. This makes our research easier because we now only have to look at the <code>schedule(</code> function which is restricted</p><p>What is the plan then ? We will call the <code>execute</code> function with arguments that makes it execute two calls: the first one to allow the vault to have the <code>PROPOSER_ROLE</code> and the second one to upgrade the vault to a contract specially crafted by us. This contract will then <code>schedule</code> the operations we are currently executing and send all funds from the vault to us. Implementation-wise the interesting bits are:</p><ul>
<li>encoding the same calls in both the transaction (<code>attacker</code> calling <code>execute(...)</code>) and the exploit contract (calling <code>schedule(...)</code>)</li><li>correctly understanding the UUPS mechanism.</li></ul><p>I will not detail the exploit further and let you look at the commented code in my repo. Please note than they are many different ways to exploit this vulnerability even though always relying on the fact than someone can hijack the execution flow to their advantage in the <code>execute</code> function.</p><ul>
<li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/tree/solutions/contracts/climber target=_blank rel="noopener noreferrer">See challenge contracts</a></li><li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/blob/solutions/test/climber/climber.challenge.js target=_blank rel="noopener noreferrer">See deploy and exploit JS code</a></li><li><a href=https://github.com/haroldm/damn-vulnerable-defi-solutions/blob/solutions/contracts/attacker-contracts/ClimberAttacker.sol target=_blank rel="noopener noreferrer">See exploit contract</a></li></ul><h2 id=conclusion>Conclusion<a class="anchor ms-1" href=#conclusion><i class="fas fa-link"></i></a></h2><p>All the vulnerabilities present in these challenges comes could have been avoided by reading the numerous warnings in Solidity and OpenZeppelin documentations, respecting safe Solidity patterns and developing contracts more carefully. The latter is easier said than done thus leading to infamous hacks (see for instance this <a href=https://rekt.news/leaderboard/ target=_blank rel="noopener noreferrer">leaderboard</a>) and bounties (see for instance <a href=https://medium.com/immunefi target=_blank rel="noopener noreferrer">Immunefi blog</a>). In real life, exploitation is trickier with balance requirements, <a href=https://www.paradigm.xyz/2020/08/ethereum-is-a-dark-forest target=_blank rel="noopener noreferrer">mempool transaction stealing</a> and lawfulness of your actions. Fortunately the bug bounty culture of the DeFi space is very advantageous to the honest researcher: I encourage you to check out some of the rewards on <a href=https://immunefi.com/explore/ target=_blank rel="noopener noreferrer">Immunefi</a>. Happy hacking !</p></div></div><div class=card-footer></div></article><div class="card component row post-comments" id=post-comments>
<div class=card-header>
<h2 class=card-title>Comments</h2></div><div class=card-body><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//haroldm.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></div><aside class="col-lg-4 sidebar d-flex">
<div class="container d-flex flex-column">
<section class="card row text-center profile component">
<div class=card-body>
<div class="col-12 d-flex align-items-center justify-content-center"><img class="profile-avatar rounded-circle" alt=Harold src=https://haroldm.github.io/images/profile.webp loading=lazy width=259 height=259>
</div><div class="col-12 profile-meta"><div class=profile-name>Harold</div><div class=profile-location><i class="fas fa-fw fa-map-marker-alt"></i>France</div><div class=profile-about><i class="fas fa-fw fa-user"></i><a href=https://haroldm.github.io/about/>About Me</a></div><nav class="social-links nav justify-content-center"><a class="nav-link social-link" target=_blank href=https://github.com/haroldm title=GitHub rel="noopener noreferrer">
<i class="fa-fw fa-2x fab fa-github"></i>
</a><a class="nav-link social-link" target=_blank href=https://twitter.com/__hrld title=Twitter rel="noopener noreferrer">
<i class="fa-fw fa-2x fab fa-twitter"></i>
</a></nav></div></div></section><div class="post-toc row mb-4 card component" id=postTOC>
<div class=card-header>
<h2 class=card-title>Contents</h2></div><div class=card-body>
<nav id=TableOfContents>
<ul>
<li><a href=#introduction>Introduction</a></li><li><a href=#challenge-1-unstoppable>Challenge 1: Unstoppable</a></li><li><a href=#challenge-2-naive-receiver>Challenge 2: Naive receiver</a></li><li><a href=#challenge-3-truster>Challenge 3: Truster</a></li><li><a href=#challenge-4-side-entrance>Challenge 4: Side entrance</a></li><li><a href=#challenge-5-the-rewarder>Challenge 5: The rewarder</a></li><li><a href=#challenge-6-selfie>Challenge 6: Selfie</a></li><li><a href=#challenge-7-compromised>Challenge 7: Compromised</a></li><li><a href=#challenge-8-puppet>Challenge 8: Puppet</a></li><li><a href=#challenge-9-puppet-v2>Challenge 9: Puppet v2</a></li><li><a href=#challenge-10-free-rider>Challenge 10: Free rider</a></li><li><a href=#challenge-11-backdoor>Challenge 11: Backdoor</a></li><li><a href=#challenge-12-climber>Challenge 12: Climber</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></div><section class="recent-posts row card component">
<div class=card-header>
<h2 class=card-title>Recent Posts</h2></div><div class=card-body>
<ul class=post-list><li>
<a href=https://haroldm.github.io/posts/damn-vulnerable-defi-write-up/>Damn Vulnerable DeFi Write-Up
</a>
</li></ul></div></section><section class="tags-taxonomies row card component">
<div class=card-header>
<h2 class=card-title>
<a href=https://haroldm.github.io/tags>Tags</a>
</h2></div><div class=card-body>
<div class=py-2><a href=https://haroldm.github.io/tags/defi/ class="badge rounded post-taxonomy" title=defi>
defi<span class="badge badge-sm text-white bg-accent ms-1">1</span></a></div></div></section></div></aside></div></main><footer class="footer mt-auto py-3 text-center container"><nav class="social-links nav justify-content-center mb-2"></nav><div class="copyright mb-2">
</div><div class="powered-by mb-2">
Powered by <a href=https://gohugo.io target=_blank rel="noopener noreferrer">Hugo</a> and the <a href=https://github.com/razonyang/hugo-theme-bootstrap target=_blank rel="noopener noreferrer">Bootstrap</a> theme.
</div></footer><script src=https://haroldm.github.io/js/main.23d11b286f748084b39994055fb614c026cef342bc2fb5e15a0938f05d201c0d.js integrity="sha256-I9EbKG90gISzmZQFX7YUwCbO80K8L7XhWgk48F0gHA0=" crossorigin=anonymous defer></script><script src=https://haroldm.github.io/js/icons.min.9d2ffa3761d1fc3f2b70b7d0727df781314311765f60541ec864acf5e84e3acb.js integrity="sha256-nS/6N2HR/D8rcLfQcn33gTFDEXZfYFQeyGSs9ehOOss=" crossorigin=anonymous defer></script>
<script src=https://haroldm.github.io/js/viewer.min.56cda9e4d5250af6a4ac0304cbfdfa39dfb9288c83167984c4ed7fbe2a54c34d.js integrity="sha256-Vs2p5NUlCvakrAMEy/36Od+5KIyDFnmExO1/vipUw00=" crossorigin=anonymous defer></script>
</body></html>